# Исследование: выбор хранилища
Задача: сохранить метки данных о просмотрах фильмов из приложения в аналитическое хранилище. 
Это позволит аналитикам изучать историю просмотров и предлагать улучшения онлайн-кинотеатра.

Для тестирования были выбраны 2 хранилища Clickhouse и Vertica.  
Протестируем работоспособность схемы хранения и обработки данных на нашей задаче.

## 1. Подготовка кластера хранилища для работы
```
docker-compose up -d
```
 
## 2. Загрузка или генерация первоначальных данных

- Установите зависимости:
```
python -m venv venv
.\venv\Scripts\activate
pip install -r requirements.txt
```

Заполним данными выбранные хранилища. Для этого сгенерируем и вставим 10 000 000 записей (пачками по 10 тыс.).
- Запустите скрипты:
```
python -m data_filling.clickhouse
python -m data_filling.vertica
```
Загрузка 10 млн. записей в Clickhouse заняла 106.5 секунд, Vertica - 135.2 сек. Преимущество за Clickhouse.

## 3. Тестирование обработки уже загруженных данных
- Для выполнения тестов последовательно запустите скрипты:
```
python -m data_selecting.clickhouse
python -m data_selecting.vertica
```

Результаты выполнения тестов можно посмотреть в `data_selecting_results.csv`:

| Запрос                                                  | Clickhouse  | Vertica  |
|---------------------------------------------------------|-------------|----------|
| Список всех фильмов пользователя                        | 0.0471      | 0.0151   |
| Все фильмы пользователя с наибольшим временем просмотра | 0.0513      | 0.0141   |
| Самый продолжительный просмотра фильма пользователем    | 0.0507      | 0.0116   |
| Список пользователей смотревших фильм                   | 0.0824      | 0.0497   |
| Запрос общего количества записей                        | 0.0533      | 0.0136   |
| Среднее время просмотра каждого фильма                  | 0.0907      | 0.3855   |
| Список всех пользователей                               | 1.571       | 2.9285   |
| Количество запусков просмотра                           | 1.6974      | 3.9092   |

По результатам теста имеем преимущество за Vertica для простых запросов с фильтрацией данных (WHERE), в то же время Clickhouse имеет значительное преимущество в более сложных запросах с группировкой и агрегацией данных.


## 4. Тестирование обработки данных, поступающих в реальном времени
- Для выполнения тестов последовательно запустите скрипты:
```
python -m data_inserting.clickhouse
python -m data_inserting.vertica
```

Результаты выполнения тестов можно посмотреть в `data_selecting_results.csv`:

| Chunk    | Clickhouse | Vertica |
|----------|------------|---------|
| 100      | 0.0993     | 0.0605  |
| 200      | 0.099      | 0.0575  |
| 500      | 0.1008     | 0.0412  |
| 1000     | 0.096      | 0.0608  |
| 2000     | 0.0588     | 0.0697  |
| 4000     | 0.0964     | 0.054   |
| 5000     | 0.0763     | 0.0611  |
| 6000     | 0.1175     | 0.0985  |
| 8000     | 0.0768     | 0.1313  |
| 10000    | 0.0854     | 0.1238  |
| 100000   | 0.4191     | 0.9818  |
| 200000   | 0.7746     | 1.9499  |
| 500000   | 1.9763     | 4.8919  |
| 1000000  | 3.8174     | 8.7028  |


По результатам тестов, мы видим, что с увеличением пачки Clickhouse демонстрирует преимущество в операциях ставке данных в сравнении с Vertica.
Для пачек размером ниже 6000 записей имеется значительный разброс времени выполнения теста (разница достигает 30%), отмечаем небольшое преимущество за Vertica. 
Для пачек с большим количеством записей, результаты гораздо стабильные (разница не более 10%).

# Выводы
Протестированы операции вставки и чтение записей. По результатам исследования Clickhouse оказался более производительной СУБД для вставок большой размерности и сложных запросов, поэтому был выбран в качестве OLAP-хранилища.

Тесты производились на ПК с характеристиками:
ЦП: AMD Ryzen 9 3900X 3.80ГГц
ОЗУ: Kingston 2*16Гб 3.2ГГц
Память: Samsung Evo Plus 970 1Тб
ОС: Windows 11 Pro
Ресурсы ограничивались средой виртуализации WSL 2, и Docker 24.0.2 контейнерами 8 CPU, 8 GB RAM для каждого из узлов.
